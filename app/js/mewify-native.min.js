var angular=require("angular"),configs=require("./libs/configs");window.configs=configs;var clientHandler=require("./libs/clientHandler");window.clientHandler=clientHandler;var configCtrl=require("./controllers/configCtrl"),app=angular.module("mewifyApp",[]);app.controller("configCtrl",["$scope",configCtrl]);var configCtrl=function(e){configs.init(function(){e.configs=configs,e.clientConfig=e.configs["default"],e.clientConfigStr=JSON.stringify(e.clientConfig),e.$$phase||e.$apply()}),e.showSave=!1,e.showStart=!0,e.showStop=!1,e.disableForm=!1,e.clientHandler=null,e.$watch("clientConfig",function(){JSON.stringify(e.clientConfig)!=e.clientConfigStr?e.showSave=!0:e.showSave=!1},!0),e.saveConfig=function(){fileIO.writeFile(configs.getConfigPath(),JSON.stringify(e.clientConfig,null,4),function(r){r.error?Events.Error(r.msg):(e.clientConfigStr=JSON.stringify(e.clientConfig),e.showSave=!1,e.$$phase||e.$apply())})},e.start=function(){e.clientHandler||(e.clientHandler=new clientHandler(e.clientConfig.ipc[e.configs.platform],e.clientConfig.httpPort,e.clientConfig.httpsPort),e.showStart=!1,e.showStop=!0,e.disableForm=!0)},e.stop=function(){e.clientHandler&&(e.clientHandler.disconnect(),e.showStart=!0,e.showStop=!1,e.clientHandler=null,e.disableForm=!1)}};module.exports=configCtrl;var ipcProvider=require("./ipcProvider"),httpProvider=require("./httpProvider"),clientHandler=function(e,r,t){fileIO.deleteFileSync(e),this.ipcProvider=new ipcProvider(e,netIO.net),this.httpProvider=new httpProvider(r,t)};clientHandler.prototype.disconnect=function(){this.ipcProvider.disconnect(),this.httpProvider.disconnect()},module.exports=clientHandler;var configs=function(){};configs.init=function(e){var r=this;this.platform=os.platform(),this.homeDir=os.homedir();var t=require("../../../configs/default.json");t.configDir[this.platform]=t.configDir[this.platform].replace("[[HOME_DIR]]",this.homeDir),t.ipc[this.platform]=t.ipc[this.platform].replace("[[HOME_DIR]]",this.homeDir),t.keystore[this.platform]=t.keystore[this.platform].replace("[[HOME_DIR]]",this.homeDir),this.paths={},this.paths.configFile=t.configDir[this.platform]+"conf.json",fileIO.existsSync(this.paths.configFile)?fileIO.readFile(this.paths.configFile,function(t){t.error?Events.Error(t.msg):(r["default"]=JSON.parse(t.data),e&&e())}):fileIO.makeDirs(t.configDir[this.platform],function(n){n.error?Events.Error(n.msg):fileIO.writeFile(r.paths.configFile,JSON.stringify(t,null,4),function(n){n.error?Events.Error(n.msg):(r["default"]=t,fileIO.makeDirs(r["default"].keystore[r.platform],function(){}),e&&e())})})},configs.getConfigPath=function(){return configs["default"].configDir[configs.platform]+"conf.json"},configs.getConfigDir=function(){return configs["default"].configDir[configs.platform]},configs.getKeysPath=function(){return configs["default"].keystore[configs.platform]},configs.getNodeUrl=function(){return JSON.parse(configs["default"].node).url},configs.getNodeName=function(){return JSON.parse(configs["default"].node).name},configs.getNodeChainId=function(){return JSON.parse(configs["default"].node).chainId},module.exports=configs;var rpcClient=require("./rpcClient"),rpcHandler=require("./rpcHandler"),httpProvider=function(e,r){this.rpcClient=new rpcClient(configs.getNodeUrl());var t=this,n=netIO.express();n.use(netIO.bodyParser.json());var t=this;n.post("/",function(e,r){r.connected=!0,r.connType="http",new rpcHandler(r,t.rpcClient).sendResponse(e.body)});try{t.httpServer=netIO.http.createServer(n),t.httpServer.listen(e),console.log("http server started")}catch(o){console.log(o),Events.Error(o.message)}var i=function(e){try{t.httpsServer=netIO.https.createServer({key:e.serviceKey,cert:e.certificate},n),t.httpsServer.listen(r),console.log("https server started")}catch(o){console.log(o),Events.Error(o.message)}},s=configs.getConfigDir()+"ssl_key";fileIO.existsSync(s)?fileIO.readFile(s,function(e){if(e.error)Events.Error(e.msg);else{var r=JSON.parse(e.data);i(r)}}):netIO.pem.createCertificate({days:3650,selfSigned:!0},function(e,r){fileIO.writeFile(s,JSON.stringify(r,null,4),function(e){e.error&&Events.Error(e.msg)}),i(r)})};httpProvider.prototype.disconnect=function(){this.httpServer&&this.httpServer.close(),console.log("http server closed"),this.httpsServer&&this.httpsServer.close(),console.log("https server closed")},module.exports=httpProvider;var rpcClient=require("./rpcClient"),rpcHandler=require("./rpcHandler"),IpcProvider=function(e,r){var t=this;this.responseCallbacks={},this.path=e,this.clients=[],this.rpcClient=new rpcClient(configs.getNodeUrl()),this.server=r.createServer(function(e){console.log("new Client! Total Clients: "+t.clients.length),Events.Info("new Client! Total Clients: "+t.clients.length),e.connected=!0,e.connType="ipc",e.rpcHandler=new rpcHandler(e,t.rpcClient),e.on("data",function(r){t._parseResponse(r.toString()).forEach(function(r){e.rpcHandler.sendResponse(r)})}),e.on("end",function(){e.connected=!1,t.clients.splice(t.clients.indexOf(e),1)}),t.clients.push(e)}),this.server.on("listening",function(){console.log("Connection started")}),this.server.on("close",function(e){console.log("Connection closed")}),this.server.on("error",function(e){console.error("IPC Connection Error",e)}),this.server.listen({path:this.path})};IpcProvider.prototype._parseResponse=function(e){var r=this,t=[],n=e.replace(/\}[\n\r]?\{/g,"}|--|{").replace(/\}\][\n\r]?\[\{/g,"}]|--|[{").replace(/\}[\n\r]?\[\{/g,"}|--|[{").replace(/\}\][\n\r]?\{/g,"}]|--|{").split("|--|");return n.forEach(function(e){r.lastChunk&&(e=r.lastChunk+e);var n=null;try{n=JSON.parse(e)}catch(o){return void(r.lastChunk=e)}n&&t.push(n)}),t},IpcProvider.prototype.isConnected=function(){return this.server.listening},IpcProvider.prototype.disconnect=function(){this.server.close()},IpcProvider.prototype.send=function(e){this.connection.write(JSON.stringify(e))},module.exports=IpcProvider;var parityOutputProcessor=function(){this.processMethods={eth_getTransactionReceipt:"ethGetTransactionReceipt"},this.queue={}};parityOutputProcessor.prototype.preProcess=function(e){var r=this;Array.isArray(e)?e.forEach(function(e){r.processMethods[e.method]&&(r.queue[e.id]=r.processMethods[e.method])}):r.processMethods[e.method]&&(r.queue[e.id]=r.processMethods[e.method])},parityOutputProcessor.prototype.postProcess=function(e){var r=this;return Array.isArray(e)?e.forEach(function(e){r.queue[e.id]&&(e=parityOutputProcessor[r.queue[e.id]](e),delete r.queue[e.id])}):r.queue[e.id]&&(e=parityOutputProcessor[r.queue[e.id]](e),delete r.queue[e.id]),e},parityOutputProcessor.ethGetTransactionReceipt=function(e){return e.result&&!e.result.blockNumber&&(e.result=null),e},module.exports=parityOutputProcessor;var privMethodHandler=function(e){this.server=e,this.handleMethods={eth_accounts:"ethAccounts",personal_listAccounts:"ethAccounts",eth_coinbase:"ethCoinbase",personal_signAndSendTransaction:"signAndSendTransaction",personal_newAccount:"personalNewAccount",rpc_modules:"rpcModules"}};privMethodHandler.accounts=[],privMethodHandler.prototype.handle=function(e,r,t){this[this.handleMethods[e]](r,t)},privMethodHandler.prototype.rpcModules=function(e,r){r(privMethodHandler.getCallbackObj(!1,"",{eth:"1.0",net:"1.0",parity:"1.0",rpc:"1.0",traces:"1.0",web3:"1.0",personal:"1.0"}))},privMethodHandler.prototype.personalNewAccount=function(e,r){try{var t=ethUtil.Wallet.generate(),n=configs.getKeysPath()+t.getV3Filename();fileIO.writeFile(n,t.toV3String(e[0]),function(e){e.error?r(privMethodHandler.getCallbackObj(!0,e.msg,"")):(privMethodHandler.accounts.push({address:t.getAddressString(),path:n}),r(privMethodHandler.getCallbackObj(!1,"",t.getAddressString())))})}catch(o){r(privMethodHandler.getCallbackObj(!0,o.message,""))}},privMethodHandler.prototype.ethCoinbase=function(e,r){privMethodHandler.accounts.length?r(privMethodHandler.getCallbackObj(!1,"",privMethodHandler.accounts[0].address)):this.ethAccounts("",function(e){r(e.error?e:e.data.length?privMethodHandler.getCallbackObj(!1,"",e.data[0]):privMethodHandler.getCallbackObj(!1,"",""))})},privMethodHandler.prototype.ethAccounts=function(e,r){var t=this;if(privMethodHandler.accounts.length){var n=[];privMethodHandler.accounts.forEach(function(e){n.push(e.address)}),r(privMethodHandler.getCallbackObj(!1,"",n))}else{var o=[];fileIO.readAllFiles(configs.getKeysPath(),function(n,i,s){privMethodHandler.isJSON(i)&&JSON.parse(i).address&&o.push({address:privMethodHandler.sanitizeAddress(JSON.parse(i).address),path:n}),s&&(privMethodHandler.accounts=o,privMethodHandler.accounts.length?t.ethAccounts(e,r):r(privMethodHandler.getCallbackObj(!1,"",[])))},function(e){Events.Error(e),r(privMethodHandler.getCallbackObj(!0,e,[]))})}},privMethodHandler.prototype.signAndSendTransaction=function(e,r){var t=this;privMethodHandler.accounts.forEach(function(n){n.address==e[0].from&&fileIO.readFile(n.path,function(n){n.error?r(n):t.server.getResponse({jsonrpc:"2.0",method:"eth_getTransactionCount",params:[e[0].from,"latest"],id:privMethodHandler.getRandomId()},function(o){if(o.error)r(privMethodHandler.getCallbackObj(!0,o.error.message,""));else try{e[0].nonce=o.result,e[0].chainId=configs.getNodeChainId();var i=new ethUtil.Tx(e[0]);i.sign(ethUtil.Wallet.fromV3(n.data,e[1],!0).getPrivateKey());var s=i.serialize().toString("hex");t.server.getResponse({jsonrpc:"2.0",method:"eth_sendRawTransaction",params:["0x"+s],id:privMethodHandler.getRandomId()},function(e){r(e.error?privMethodHandler.getCallbackObj(!0,e.error.message,""):privMethodHandler.getCallbackObj(!1,"",e.result))})}catch(c){Events.Error(c.message),r(privMethodHandler.getCallbackObj(!0,c.message,[]))}})})})},privMethodHandler.getCallbackObj=function(e,r,t){return{error:e,msg:r,data:t}},privMethodHandler.sanitizeAddress=function(e){return e="0x"==e.substring(0,2)?e.substring(2):e,"0x"+e},privMethodHandler.isJSON=function(e){try{JSON.parse(e)}catch(r){return!1}return!0},privMethodHandler.getRandomId=function(){return ethUtil.crypto.randomBytes(16).toString("hex")},privMethodHandler.updataAccounts=!1,module.exports=privMethodHandler;var parityOutputProcessor=require("./parityOutputProcessor"),rpcClient=function(e){this.server=e,this.request=netIO.request.defaults({jar:!0}),this.parityOutputProcessor=new parityOutputProcessor};rpcClient.prototype.call=function(e,r){var t=this;t.request({url:t.server,method:"POST",json:!0,body:e},function(e,t,n){r(e,t,n)})},rpcClient.prototype.getResponse=function(e,r){var t=this;t.parityOutputProcessor.preProcess(e),t.call(e,function(e,n,o){e?Events.Error(e):(o=t.parityOutputProcessor.postProcess(o),r(o))})},module.exports=rpcClient;var privMethodHandler=require("./privMethodHandler"),rpcHandler=function(e,r){this.client=e,this.server=r,this.privMethodHandler=new privMethodHandler(r)};rpcHandler.prototype.sendResponse=function(e){console.log(e);var r=!1,t=this;if(Array.isArray(e)){r=!0;for(var n in e)if(e[n].method&&!rpcHandler.isAllowedMethod(e[n].method)&&(this.write(rpcHandler.getInvalidMethod(e[n].method,e[n].id)),e.splice(n,1)),e[n].method&&rpcHandler.isPrivMethod(e[n].method)){var o=function(e){t.privMethodHandler.handle(e.method,e.params,function(r){r.error?t.write(rpcHandler.getErrorMsg(r.msg,e.id)):t.write(rpcHandler.getResultMsg(r.data,e.id))})};o(e[n]),e.splice(n,1)}}else e.method&&!rpcHandler.isAllowedMethod(e.method)?this.write(rpcHandler.getInvalidMethod(e.method,e.id)):e.method||this.write(rpcHandler.getInvalidMethod("Invalid number of input parameters",e.id));Array.isArray(e)?e.length&&t.server.getResponse(e,function(e){t.write(e)}):rpcHandler.isPrivMethod(e.method)?t.privMethodHandler.handle(e.method,e.params,function(r){r.error?t.write(rpcHandler.getErrorMsg(r.msg,e.id)):t.write(rpcHandler.getResultMsg(r.data,e.id))}):t.server.getResponse(e,function(e){t.write(e)})},rpcHandler.prototype.write=function(e){var r=this;r.client.connected&&(console.log(e),"ipc"==r.client.connType?r.client.write(JSON.stringify(e)):"http"==r.client.connType&&r.client.json(e))},rpcHandler.getInvalidMethod=function(e,r){return Events.Error("{"+e+"} Method not found or unavailable"),{jsonrpc:"2.0",error:{code:-32601,message:"{"+e+"} Method not found or unavailable",data:null},id:r}},rpcHandler.getErrorMsg=function(e,r){return Events.Error(e),{jsonrpc:"2.0",error:{code:-1,message:e,data:null},id:r}},rpcHandler.getResultMsg=function(e,r){return{jsonrpc:"2.0",result:e,id:r}},rpcHandler.isPrivMethod=function(e){return rpcHandler.privMethods.indexOf(e)>-1},rpcHandler.isAllowedMethod=function(e){return rpcHandler.remoteMethods.indexOf(e)>-1||rpcHandler.isPrivMethod(e)},rpcHandler.remoteMethods=require("./methods/remoteMethods.json"),rpcHandler.privMethods=require("./methods/privMethods.json"),module.exports=rpcHandler;
//# sourceMappingURL=maps/mewify-native.min.js.map
